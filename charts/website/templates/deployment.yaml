apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "website.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "website.labels" . | nindent 4 }}

spec:
    replicas: {{ .Values.replicaCount }}
    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 0
    selector:
      matchLabels:
        app.kubernetes.io/name: {{ include "website.fullname" . }}
    template:
        metadata:
          annotations: 
            checksum/config: {{ .Values.secretMessage | sha256sum }}
          labels:
              {{- include "website.labels" . | nindent 14 }}
        spec:
            containers:
                - name: {{ include "website.fullname" . }}
                  image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
                  imagePullPolicy: {{ .Values.image.pullPolicy }}
                  ports:
                    - name: http
                      containerPort: 80
                      protocol: TCP
                  env:
                    - name: ENVIRONMENT
                      value: {{ .Values.environment | quote }}
                    - name: SECRET_MESSAGE
                      valueFrom:
                        secretKeyRef:
                          name: {{ include "website.fullname" . }}-secret
                          key: secretMessage
